<html>
   <head>
      <title>Real</title>
   </head>
   <body onload="init();">
      <canvas id="canvas" width="1000" height="500" style="background-color:#333333;" ></canvas>
   <strong><pre>left click:new line
right click:new shape
</pre></strong>
   </body
>   <script type="text/javascript" src="js/box2d.js"></script>
   <script type="text/javascript" src="js/box_utils.js"></script>
   <script type="text/javascript">
var C = {};
var world, ctx, player, SCALE = 30;
var prev_mX = -1,prev_mY = -1;

var LINES = []

function addLine(a,b){
    LINES.push([a,b]);
    addPhysicLine(a,b);
}

function init() {
    ctx = document.getElementById('canvas').getContext('2d');
    world = new b2World(new b2Vec2(0, 10) /*gravity*/,true /*sleep*/);

    var p1 = new b2Vec2(0, 5);
    var p2 = new b2Vec2(5, 5);
    var p3 = new b2Vec2(10, 10);
    var p4 = new b2Vec2(40, 10);
    addLine(p1,p2);
    addLine(p2,p3);
    addLine(p3,p4);

    //setup debug draw
    var debugDraw = new b2DebugDraw();
       debugDraw.SetSprite(ctx);
       debugDraw.SetDrawScale(SCALE);
       debugDraw.SetFillAlpha(0.3);
       debugDraw.SetLineThickness(1.0);
       debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
       world.SetDebugDraw(debugDraw);

    document.addEventListener("mousedown", function(e) {
        var mouseX = e.clientX/SCALE;
        var mouseY = e.clientY/SCALE;
        if(e.button === 0){ //left click
            if(prev_mX != -1){
                addLine(new b2Vec2(prev_mX,prev_mY), new b2Vec2(mouseX, mouseY));
            }
            prev_mX = mouseX;
            prev_mY = mouseY;
        }else{
            addDynCircle(mouseX,mouseY);
        }
    }, true)

    document.addEventListener("contextmenu", function(e) {
        e.preventDefault();
    }, false);

    document.addEventListener("keydown", function(e){
        //console.log(e);
        switch(e.keyCode) {
            case 38://up
            case 32://space
                player.m_body.ApplyImpulse(new b2Vec2(0,4), player.m_body.GetLocalCenter())
                break;
            case 39:
                player.m_body.ApplyImpulse(new b2Vec2(1,0), player.m_body.GetWorldCenter())
                break;
            case 37:
                player.m_body.ApplyImpulse(new b2Vec2(-1,0), player.m_body.GetWorldCenter())
                break;
        }
        //e.preventDefault();
    })

    player = createPlayer(1,1);

    //image loading
    var images_to_load = 1;
    var img_loading_counter = 0;

    function lauch_if_loaded(){
      img_loading_counter += 1;
      console.log("loading: "+img_loading_counter+"/"+images_to_load)
      if(images_to_load <= img_loading_counter){
        tick();
      }
    }

    C.bg = new Image();
    C.bg.onload = function() { lauch_if_loaded(); }
    C.bg.src = "bg.jpg";
}

function draw() {
    ctx.drawImage(C.bg,0,0);
    LINES.forEach(function(x){
        var a = x[0], b = x[1];
        ctx.beginPath();
        ctx.moveTo(a.x*SCALE,a.y*SCALE);
        ctx.lineTo(b.x*SCALE,b.y*SCALE);
        ctx.stroke();
    })
    var player_pos = player.m_body.GetWorldPoint(new b2Vec2(0,0))
    ctx.rect(player_pos.x*SCALE,player_pos.y*SCALE,10,15);
    ctx.fill(); 
    //world.DrawDebugData();
}

function tick() {
  requestAnimationFrame(tick, 1000/60 );
  draw();
  world.Step(1 / 60, 10, 10);
  world.ClearForces();
};
      
   </script>
</html>